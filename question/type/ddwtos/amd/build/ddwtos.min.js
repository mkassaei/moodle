define(["jquery","core/dragdrop"],function(a,b){"use strict";var c={DRAG_PROXIMITY:10,CONTAINER_BORDER_TOLERANCE:10,ANIMATION_DURATION:300,params:{},nextDragItemNo:1,cssSelectors:function(a){return{topNode:function(){return a},dragContainer:function(){return a+" div.drags"},drags:function(){return this.dragContainer()+" span.drag"},drag:function(a){return this.drags()+".no"+a},dragsInGroup:function(a){return this.drags()+".group"+a},dragsForChoiceInGroup:function(a,b){return this.dragsInGroup(b)+".choice"+a},placedDragsInGroup:function(a){return this.dragsInGroup(a)+".placed"},unplacedDragsInGroup:function(a){return this.dragsInGroup(a)+".unplaced"},unplacedDragsForChoiceInGroup:function(a,b){return this.unplacedDragsInGroup(b)+".choice"+a},dragHomes:function(){return a+" span.draghome"},dragHomesGroup:function(b){return a+" .draggrouphomes"+b+" span.draghome"},dragHome:function(b,c){return a+" .draggrouphomes"+b+" span.draghome.choice"+c},drops:function(){return a+" span.drop"},dropForPlace:function(a){return this.drops()+".place"+a},dropsInGroup:function(a){return this.drops()+".group"+a},dropsGroup:function(b){return a+" span.drop.group"+b}}},getInputIds:function(b){var c=[],d=0;return a(b).find("input[type=hidden]").each(function(e,f){var g=parseInt(b.match(/\d/g));a(f)[0].id.indexOf("_"+g+"_p")!==-1&&(c[++d]=a(f)[0].id)}),c},getInputId:function(a,b){return c.getInputIds(a)[b]},init:function(a){var b="qtype_ddwtos-"+Math.random().toString(36).slice(2);M.util.js_pending(b),c.params=a,c.initQuestion(a.topnode),M.util.js_complete(b)},updateOnResize:function(b){a(window).on("resize",function(){c.updateDragsPositions(b)}).resize()},initQuestion:function(b){1!==a(b).data("initialised")&&(c.setPaddingSizesAll(b),c.cloneDragItems(b),c.updateDragsPositions(b),c.updateOnResize(b),c.makeDropZones(b),a(b).data("initialised",1))},putDragInDrop:function(b,d,e){var f=a("input#"+c.getInputId(b,c.getPlace(e)));if(f.val()>0){var g=a(c.cssSelectors(b).dragsForChoiceInGroup(f.val(),c.getGroup(e)));g.length&&c.putBackToOrigin(b,g)}d&&d.length?(f.val(c.getChoice(d)),c.setDragOffset(d,e),d.css("z-index",Number(d.css("z-index"))-1)):(f.val(0),d.removeClass("placed"),d.addClass("unplaced"))},updateDragsPositions:function(b){var d=a(c.cssSelectors(b).drags());d.addClass("unplaced");for(var e=0;e<d.length;e++){var f=a(d[e]),g=c.getGroup(f),h=c.getChoice(f);f.offset(a(b+" .draggrouphomes"+g+" span:nth-child("+h+")").offset())}for(var i in c.getInputIds(b)){var j=a("input#"+c.getInputId(b,i)),h=Number(j.val());if(0!==h){var k=a(c.cssSelectors(b).dropForPlace(i)),g=c.getGroup(k),l=a(c.cssSelectors(b).unplacedDragsForChoiceInGroup(h,g));l.hasClass("infinite")&&(l=a(c.cssSelectors(b).drag(c.getNo(l)))),c.setDragOffset(l,k)}}},cloneDragItems:function(b){c.nextDragItemNo=1,a(c.cssSelectors(b).dragHomes()).each(function(d,e){c.cloneDragItemsForOneChoice(b,a(e))})},cloneDragItemsForOneChoice:function(b,d){if(d.hasClass("infinite"))for(var e=c.getGroup(d),f=a(c.cssSelectors(b).dropsInGroup(e)).length,g=0;g<f;g++)c.cloneDragItem(b,d);else c.cloneDragItem(b,d)},cloneDragItem:function(b,d){var e=d.clone();e.removeClass("draghome"),e.addClass("drag"),e.addClass("no"+c.nextDragItemNo),c.nextDragItemNo++,e.css({top:d.offset().top,left:d.offset().left,visibility:"visible",position:"absolute"}),a(c.cssSelectors(b).dragContainer()).append(e),c.params.readonly||(e.addClass("unplaced"),e.on("mousedown touchstart",c.mouseDownOrTouchStart(b,e)))},mouseDownOrTouchStart:function(a,d){return function(e){if(b.prepare(e).start===!0){e.preventDefault(),d.css("cursor","move"),d.addClass("moodle-has-zindex");var f=c.getChoice(d),g=c.getGroup(d),h={};h.id="g"+g+"c"+f,h.group=g,h.choice=f,h.drag=d,h.origin=d.position();var i=function(b,e){c.onMove(a,b,e,h,d)},j=function(){c.onDrop(a,h,d)};d.css("z-index",Number(d.css("z-index"))+1),b.start(e,d,i,j)}}},onMove:function(b,d,e,f,g){var h=a(b).find(".formulation");if(c.isDragOutsideQuestionContainer(h,d,e))return h.addClass("outside-container"),void g.on("mouseup",function(){h.removeClass("outside-container")});var i=a(c.cssSelectors(b).dropsInGroup(f.group));i.each(function(b,d){c.isDragCloseToTarget(g,a(d))?a(d).addClass("valid-drag-over-drop"):a(d).removeClass("valid-drag-over-drop")})},onDrop:function(b,d,e){var f=a(c.cssSelectors(b).dropsInGroup(d.group)),g=!1;return f.each(function(d,f){return c.isDragInTheSameDrop(e,a(f))?(g=!0,!1):c.isDragCloseToTarget(e,a(f))?(a(f).removeClass("valid-drag-over-drop"),c.putDragInDrop(b,a(e),a(f)),g=!0,!1):void 0}),!g&&void c.putBackToOrigin(b,e)},makeDropZones:function(b){a(c.cssSelectors(b).drops()).each(function(d,e){c.makeDropZone(b,a(e))})},makeDropZone:function(a,b){c.params.readonly||b.on("keydown",function(b){c.dropZoneKeyPress(a,b)})},putBackToOrigin:function(b,d){d.removeClass("placed"),d.addClass("unplaced");var e=c.getGroup(d),f=c.getChoice(d),g=a(b+" .draggrouphomes"+e+" span:nth-child("+f+")");c.animateEl(d,g,c.ANIMATION_DURATION,"swing")},isDragInDrop:function(a,b){if(!b.length)return!1;var c=b.children(a+" span.placed");return!!c.length&&c},isDragOutsideQuestionContainer:function(b,d,e){var f={lt:{Y:b.offset().top+c.CONTAINER_BORDER_TOLERANCE,X:b.offset().left+c.CONTAINER_BORDER_TOLERANCE},rt:{Y:b.offset().top+c.CONTAINER_BORDER_TOLERANCE,X:b.offset().left+b[0].clientWidth-c.CONTAINER_BORDER_TOLERANCE},lb:{Y:b.offset().top+b[0].clientHeight-c.CONTAINER_BORDER_TOLERANCE,X:b.offset().left},rb:{Y:b.offset().top+b[0].clientHeight-c.CONTAINER_BORDER_TOLERANCE,X:b.offset().left+b[0].clientWidth-c.CONTAINER_BORDER_TOLERANCE}};return e<f.lt.Y||d<f.lt.X?(a(b).addClass("outside-container"),!0):e<f.rt.Y||d>f.rt.X?(a(b).addClass("outside-container"),!0):e>f.lb.Y||d<f.lb.X?(a(b).addClass("outside-container"),!0):e>f.rb.Y||d>f.rb.X?(a(b).addClass("outside-container"),!0):(a(b).removeClass("outside-container"),!1)},animateEl:function(a,b,c,d){var e=Math.abs(a.css("left")-b.offset().left)+Math.abs(a.css("top")-b.offset().top);e=e>1?e:1,a.animate({opacity:.5,width:1.2*parseInt(a.css("width"))+"px",height:1.2*parseInt(a.css("height"))+"px",top:b.offset().top,left:b.offset().left},{duration:c/e,easing:d}),a.animate({opacity:1,width:parseInt(a.css("width"))+"px",height:parseInt(a.css("height"))+"px",top:b.offset().top,left:b.offset().left},{duration:c/e,easing:d})},isDragCloseToTarget:function(a,b){var d=a.offset().left+a.outerWidth()/2,e=a.offset().top+a.outerHeight()/2,f=b.offset().left+b.outerWidth()/2,g=b.offset().top+b.outerHeight()/2;return d>f-c.DRAG_PROXIMITY&&d<f+c.DRAG_PROXIMITY&&e>g-c.DRAG_PROXIMITY&&e<g+c.DRAG_PROXIMITY},setPaddingSizesAll:function(a){for(var b=1;b<=8;b++)c.setPaddingSizeForGroup(a,b)},setPaddingSizeForGroup:function(b,d){var e=a(c.cssSelectors(b).dragHomesGroup(d));if(0!=e.length){var f=0,g=0;a(e).each(function(a,b){f=Math.max(f,Math.ceil(b.offsetWidth)),g=Math.max(g,Math.ceil(b.offsetHeight))}),f+=8,g+=2,a(e).each(function(a,e){c.padWidthHeight(e,f,g),c.positionDrags(b,d,e)}),a(c.cssSelectors(b).dropsGroup(d)).each(function(a,b){c.padWidthHeight(b,f+2,g+2)})}},positionDrags:function(b,d,e){var f=a(c.cssSelectors(b).dragsInGroup(d));a(c.cssSelectors(b).dragContainer()).append(a(f).append(a(e)))},padWidthHeight:function(b,c,d){a(b).css({width:c+"px",height:d+"px",lineHeight:d+"px"})},getClassnameNumericSuffix:function(a,b){var c=a.attr("class");if(""!==c)for(var d=c.split(" "),e=0;e<d.length;e++){var f=new RegExp("^"+b+"([0-9])+$");if(f.test(d[e])){var g=new RegExp("([0-9])+$"),h=g.exec(d[e]);return Number(h[0])}}throw'Prefix "'+b+'" not found in class names.'},getChoice:function(a){return c.getClassnameNumericSuffix(a,"choice")},getGroup:function(a){return c.getClassnameNumericSuffix(a,"group")},getPlace:function(a){return c.getClassnameNumericSuffix(a,"place")},getNo:function(a){return c.getClassnameNumericSuffix(a,"no")},setDragOffset:function(a,b){a.removeClass("unplaced"),a.addClass("placed"),a.offset({top:Math.round(b.offset().top)+1,left:Math.round(b.offset().left)+1})},isDragInTheSameDrop:function(a,b){return parseInt(a.css("top"))===Math.round(b.offset().top)+1},removeDragFromDrop:function(a,b){c.putDragInDrop(a,null,b)},dropZoneKeyPress:function(b,d){var e={27:"remove",32:"next",37:"previous",38:"previous",39:"next",40:"next"};switch(d.direction=e[d.keyCode],d.direction){case"next":d.preventDefault(),c.placeNextDragIn(b,a(d.target));break;case"previous":d.preventDefault(),c.placePreviousDragIn(b,a(d.target));break;case"remove":d.preventDefault(),c.removeDragFromDrop(b,a(d.target))}},placeNextDragIn:function(a,b){c.chooseNextChoiceForDrop(a,b,1)},placePreviousDragIn:function(a,b){c.chooseNextChoiceForDrop(a,b,-1)},chooseNextChoiceForDrop:function(b,d,e){var f=c.getGroup(d),g=c.currentChoiceInDrop(b,a(d)),h=a(c.cssSelectors(b).unplacedDragsInGroup(f)),i=g,j=h.toArray();i=0===g?1===e?c.getChoice(a(j.shift())):c.getChoice(a(j.pop())):g+e;var k=a(c.cssSelectors(b).unplacedDragsForChoiceInGroup(i,f));if(0===k.length&&(k=a(c.cssSelectors(b).unplacedDragsForChoiceInGroup(i+e,f))),null===a(c.cssSelectors(b).dragsForChoiceInGroup(i,f)))return void c.removeDragFromDrop(b,d);if(k.hasClass("infinite")){var l=!1;if(k.each(function(e,f){if(a(f).hasClass("unplaced"))return c.putDragInDrop(b,a(f),d),l=!0,!1}),l)return l=!1,!1}else c.putDragInDrop(b,k,d)},currentChoiceInDrop:function(b,d){var e=a("input#"+c.getInputId(b,c.getPlace(d)));return Number(a(e).val())}};return c});